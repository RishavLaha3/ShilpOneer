<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    /

    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
  
    <title>ShilpOneer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      /* Simple Chatbot styles */
      #simple-chatbot-button {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 1000;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        background: #0d6efd;
        color: #fff;
        box-shadow: 0 6px 18px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #simple-chatbot-widget {
        position: fixed;
        right: 20px;
        bottom: 90px;
        width: 320px;
        max-height: 60vh;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow: hidden;
        display: none;
        z-index: 1000;
      }
      #simple-chatbot-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: #0d6efd;
        color: #fff;
      }
      #simple-chatbot-messages {
        padding: 12px;
        overflow-y: auto;
        max-height: 40vh;
        background: #f7f7f9;
      }
      .chat-row {
        margin-bottom: 10px;
        display: flex;
      }
      .chat-row.user {
        justify-content: flex-end;
      }
      .chat-bubble {
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 80%;
        font-size: 14px;
        line-height: 1.3;
      }
      .chat-bubble.user {
        background: #0d6efd;
        color: #fff;
        border-bottom-right-radius: 4px;
      }
      .chat-bubble.bot {
        background: #e9ecef;
        color: #212529;
        border-bottom-left-radius: 4px;
      }
      #simple-chatbot-input {
        display: flex;
        gap: 8px;
        padding: 10px;
        background: #fff;
        border-top: 1px solid #e9ecef;
      }
      #simple-chatbot-input input[type="text"] {
        flex: 1;
        border: 1px solid #ced4da;
        border-radius: 8px;
        padding: 8px 10px;
        outline: none;
      }
      #simple-chatbot-input button {
        border: none;
        background: #0d6efd;
        color: #fff;
        border-radius: 8px;
        padding: 8px 12px;
      }
    </style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
  <!-- <h1> i am react </h1>-->
    <div id="root"></div>
    <!-- Simple Chatbot UI -->
    <button id="simple-chatbot-button" aria-label="Open chat">
      <i class="fa-solid fa-comments"></i>
    </button>
    <div id="simple-chatbot-widget" role="dialog" aria-modal="false" aria-label="Chatbot">
      <div id="simple-chatbot-header">
        <div>
          <i class="fa-solid fa-robot me-2"></i> Chatbot
        </div>
        <div class="d-flex gap-2">
          <button id="simple-chatbot-apikey" class="btn btn-sm btn-outline-light" title="Set API Key">API Key</button>
          <button id="simple-chatbot-close" class="btn btn-sm btn-light">Close</button>
        </div>
      </div>
      <div id="simple-chatbot-messages" aria-live="polite"></div>
      <form id="simple-chatbot-input">
        <input id="simple-chatbot-text" type="text" placeholder="Type a message..." autocomplete="off" />
        <button type="submit">Send</button>
      </form>
    </div>

    <script>
      (function () {
        const btn = document.getElementById('simple-chatbot-button');
        const widget = document.getElementById('simple-chatbot-widget');
        const closeBtn = document.getElementById('simple-chatbot-close');
        const apiKeyBtn = document.getElementById('simple-chatbot-apikey');
        const messages = document.getElementById('simple-chatbot-messages');
        const form = document.getElementById('simple-chatbot-input');
        const input = document.getElementById('simple-chatbot-text');

        function toggleWidget(show) {
          const shouldShow = typeof show === 'boolean' ? show : widget.style.display === 'none' || widget.style.display === '';
          widget.style.display = shouldShow ? 'block' : 'none';
          if (shouldShow) {
            setTimeout(() => input && input.focus(), 50);
            // Show basic commands on first open
            if (!widget.dataset.shownBasics) {
              appendMessage("I can help with:\n- Browsing products and categories\n- Searching for items\n- Adding/removing items from your cart\n- Delivery and returns info\n- Checkout and payments\n- Contacting support", 'bot');
              widget.dataset.shownBasics = '1';
            }
          }
        }

        function appendMessage(text, sender) {
          const row = document.createElement('div');
          row.className = 'chat-row ' + (sender === 'user' ? 'user' : 'bot');
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble ' + (sender === 'user' ? 'user' : 'bot');
          bubble.textContent = text;
          row.appendChild(bubble);
          messages.appendChild(row);
          messages.scrollTop = messages.scrollHeight;
        }

        function appendTyping() {
          const row = document.createElement('div');
          row.className = 'chat-row bot';
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble bot';
          bubble.textContent = 'Typingâ€¦';
          row.appendChild(bubble);
          messages.appendChild(row);
          messages.scrollTop = messages.scrollHeight;
          return row;
        }

        async function callOpenAI(userText, apiKey) {
          try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [
                  { role: 'system', content: 'You are a helpful assistant on the ShilpOneer website. Answer concisely and helpfully.' },
                  { role: 'user', content: userText }
                ],
                temperature: 0.7
              })
            });
            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              throw new Error(err.error?.message || 'API error ' + response.status);
            }
            const data = await response.json();
            const text = data.choices?.[0]?.message?.content?.trim();
            return text || 'I could not generate a response.';
          } catch (e) {
            throw e;
          }
        }

        function botReplyFallback(userText) {
          const normalized = userText.trim().toLowerCase();
          let reply = "I'm a simple demo bot. Ask me anything!";
          if (!normalized) return;
          if (normalized.includes('hello') || normalized.includes('hi')) {
            reply = 'Hello! How can I help you today?';
          } else if (normalized.includes('help')) {
            reply = 'Sure! Briefly describe what you need help with.';
          } else if (normalized.includes('price') || normalized.includes('pricing')) {
            reply = 'Pricing details are coming soon. What features are you interested in?';
          } else if (normalized.includes('contact')) {
            reply = 'You can reach us via the contact form in the app.';
          } else {
            reply = 'Got it: "' + userText + '". I\'ll pass this along!';
          }
          setTimeout(() => appendMessage(reply, 'bot'), 400);
        }

        async function botReply(userText) {
          const apiKey = localStorage.getItem('simpleChatApiKey');
          if (!apiKey) {
            return botReplyFallback(userText);
          }
          const typingRow = appendTyping();
          try {
            const reply = await callOpenAI(userText, apiKey);
            messages.removeChild(typingRow);
            appendMessage(reply, 'bot');
          } catch (err) {
            messages.removeChild(typingRow);
            appendMessage('API error: ' + (err && err.message ? err.message : 'Unknown error') + '. Using fallback.', 'bot');
            botReplyFallback(userText);
          }
        }

        // Parse commands including: "add <product_name> to cart" and "remove <product_name> from cart"
        async function handleCommand(userText) {
          const text = userText.trim();
          const addCmdRegex = /^add\s+(.+?)(?:\s+to\s+cart)?\s*$/i;
          const removeCmdRegex = /^remove\s+(.+?)\s+from\s+cart\s*$/i;

          // ADD command
          let m = text.match(addCmdRegex);
          if (m) {
            const nameQueryRaw = m[1];
            const nameQuery = nameQueryRaw.trim().toLowerCase();
            try {
              let product = null;
              try {
                const pRes = await fetch(`http://localhost:2000/product/sel`);
                const all = await pRes.json();
                if (Array.isArray(all)) {
                  const exact = all.find(p => typeof p.pname === 'string' && p.pname.trim().toLowerCase() === nameQuery);
                  if (exact) {
                    product = exact;
                  } else {
                    product = all.find(p => typeof p.pname === 'string' && p.pname.toLowerCase().includes(nameQuery));
                  }
                }
              } catch (_) {}

              if (!product) {
                appendMessage('Could not find product named "' + nameQueryRaw + '".', 'bot');
                return true;
              }

              const evt = new CustomEvent('chatbot:addToCart', { detail: product });
              window.dispatchEvent(evt);
              appendMessage('Added "' + (product.pname || 'product') + '" to your cart.', 'bot');
              return true;
            } catch (e) {
              appendMessage('Failed to add to cart: ' + (e && e.message ? e.message : 'Unknown error'), 'bot');
              return true;
            }
          }

          // REMOVE command
          m = text.match(removeCmdRegex);
          if (m) {
            const nameQueryRaw = m[1];
            const nameQuery = nameQueryRaw.trim();
            // Dispatch remove event with name so React can remove one instance
            const evt = new CustomEvent('chatbot:removeFromCart', { detail: { pname: nameQuery } });
            window.dispatchEvent(evt);
            appendMessage('Removed one "' + nameQuery + '" from your cart (if present).', 'bot');
            return true;
          }

          return false;
        }

        btn && btn.addEventListener('click', () => toggleWidget());
        closeBtn && closeBtn.addEventListener('click', () => toggleWidget(false));
        form && form.addEventListener('submit', function (e) {
          e.preventDefault();
          const text = input.value.trim();
          if (!text) return;
          appendMessage(text, 'user');
          input.value = '';
          // Intercept commands first
          handleCommand(text).then((handled) => {
            if (!handled) {
              botReply(text);
            }
          });
        });

        apiKeyBtn && apiKeyBtn.addEventListener('click', function () {
          const current = localStorage.getItem('simpleChatApiKey') || '';
          const entered = window.prompt('Enter your OpenAI API key (stored locally in this browser):', current);
          if (entered != null) {
            const trimmed = entered.trim();
            if (trimmed) {
              localStorage.setItem('simpleChatApiKey', trimmed);
              appendMessage('API key saved. I\'ll use it for responses.', 'bot');
            } else {
              localStorage.removeItem('simpleChatApiKey');
              appendMessage('API key cleared. I\'ll use simple built-in replies.', 'bot');
            }
          }
        });

        // Greet on first open
        let greeted = false;
        const observer = new MutationObserver(() => {
          const isOpen = widget.style.display === 'block';
          if (isOpen && !greeted) {
            greeted = true;
            appendMessage('Hi! I\'m your assistant. How can I help?', 'bot');
          }
        });
        observer.observe(widget, { attributes: true, attributeFilter: ['style'] });
      })();
    </script>
  
  </body>
</html>
